<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GOLDEN NOTES | Secure Vault</title>
    <link rel="stylesheet" href="/style.css">
</head>
<body>
    <nav>
        <div class="logo">GOLDEN NOTES</div>
        <div id="nav-links">
            <a href="#" class="nav-item" onclick="openAbout()">About</a>
            <a href="#" class="nav-item" onclick="openContact()">Support</a>
        </div>
    </nav>

    <div class="container">
        <div id="auth-view" class="hidden" style="max-width: 400px; margin: 80px auto;">
            <div style="display:flex; justify-content: center; gap: 20px; margin-bottom: 20px;">
                <span id="t-login" style="cursor:pointer; font-weight:900; color:var(--gold)" onclick="setAuthMode(true)">LOGIN</span>
                <span id="t-reg" style="cursor:pointer; font-weight:900; color:#444" onclick="setAuthMode(false)">SIGN UP</span>
            </div>
            <div class="form-box">
                <input type="email" id="email" placeholder="Email" required style="margin-bottom:15px;">
                <input type="password" id="pass" placeholder="Password" style="margin-bottom:15px;">
                <button id="auth-btn" onclick="handleAuth()" style="width: 100%;">SIGN IN</button>
            </div>
        </div>

        <div id="dash-view" class="hidden">
            <h1 style="margin: 0 0 30px 0; font-size: 1.8rem; letter-spacing: -1px;">Secure Workspace</h1>

            <div class="form-box" style="margin-bottom: 40px; background: #0a0a0a;">
                <input type="text" id="note-title" placeholder=" Record Title " style="font-weight: bold; border: none; background: transparent; border-bottom: 1px solid #222; border-radius: 0; margin-bottom: 15px; color: white;">
                
                <textarea id="note-content" placeholder="Type your encrypted thoughts..." rows="3" style="border: none; background: transparent; resize: none; margin-bottom: 15px; color: #ccc; outline: none;"></textarea>
                
                <div style="display:flex; justify-content: space-between; align-items: center; border-top: 1px solid #1a1a1a; padding-top: 15px; flex-wrap: wrap; gap: 15px;">
                    <div style="display: flex; gap: 15px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 0.65rem; color: #555; font-weight: bold;">PRIORITY:</span>
                            <select id="note-priority" style="width: auto; padding: 4px 8px; background: #1a1a1a; font-size: 0.8rem; border: 1px solid #333; color: white;">
                                <option value="Low">Low</option>
                                <option value="Normal" selected>Normal</option>
                                <option value="High">High</option>
                            </select>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 0.65rem; color: #555; font-weight: bold;">CATEGORY:</span>
                            <select id="note-category" style="width: auto; padding: 4px 8px; background: #1a1a1a; font-size: 0.8rem; border: 1px solid #333; color: white;">
                                <option value="Personal">Personal</option>
                                <option value="Work">Work</option>
                                <option value="Education">Education</option>
                                <option value="Health">Health</option>
                            </select>
                        </div>
                    </div>
                    <button onclick="saveNote()">+ Save to Vault</button>
                </div>
            </div>

            <input type="text" id="search" placeholder=" Search through your records..." oninput="currentPage=1; loadNotes()" style="margin-bottom: 30px; border-radius: 30px;">
            <div id="notes-list" class="notes-grid"></div>
            <div id="pagination"></div>
        </div>
    </div>

    <div id="aboutModal" class="modal">
        <div class="modal-content">
            <h2 style="color:var(--gold); margin-top:0;">About GOLDEN NOTES</h2>
            <p style="color: #ccc; line-height: 1.6;">Welcome to your personal encrypted vault. This application is designed to keep your thoughts and records secure using modern web technologies.</p>
            <ul style="color: #888; font-size: 0.9rem; text-align: left; margin: 15px 0;">
                <li>üîí Secure Password Hashing (Bcrypt)</li>
                <li>üç™ Session-based Authentication</li>
                <li>üè∑Ô∏è Priority & Category Organization</li>
                <li>üìÅ Contact data stored in local JSON</li>
            </ul>
            <button onclick="closeAbout()" style="width: 100%; background: #222; color: white;">Understood</button>
        </div>
    </div>

    <div id="editModal" class="modal">
        <div class="modal-content">
            <h2 style="color:var(--gold); margin-top:0;">Update Record</h2>
            <input type="hidden" id="edit-id">
            <input type="text" id="edit-title" style="margin-bottom:15px;">
            <textarea id="edit-content" rows="6" style="margin-bottom:15px;"></textarea>
            <div style="display: flex; gap: 10px;">
                <button onclick="updateNote()" style="flex: 1;">Update</button>
                <button onclick="closeEdit()" style="flex: 1; background: #222; color: white;">Cancel</button>
            </div>
        </div>
    </div>

    <div id="contactModal" class="modal">
        <div class="modal-content">
            <h2 style="color:var(--gold); margin-top:0;">Contact Support</h2>
            <input type="email" id="c-email" placeholder="Your Email" style="margin-bottom:15px;">
            <textarea id="c-message" placeholder="Describe your issue..." rows="4" style="margin-bottom:15px;"></textarea>
            <div style="display: flex; gap: 10px;">
                <button onclick="sendContact()" style="flex: 1;">Send</button>
                <button onclick="closeContact()" style="flex: 1; background: #222; color: white;">Close</button>
            </div>
        </div>
    </div>

    <script>
        let isLogin = true;
        let currentPage = 1;

        async function check() {
            const res = await fetch('/api/notes/me');
            if (res.ok) {
                const user = await res.json();
                document.getElementById('dash-view').classList.remove('hidden');
                document.getElementById('auth-view').classList.add('hidden');
                
                const initial = user.email.charAt(0).toUpperCase();
                const roleColor = user.role === 'admin' ? '#ff4d4d' : 'var(--gold)';
                
                document.getElementById('nav-links').innerHTML = `
                    <a href="#" class="nav-item" onclick="openAbout()">About</a>
                    <a href="#" class="nav-item" onclick="openContact()">Support</a>
                    <div class="user-profile-wrapper">
                        <span class="role-badge-text" style="color: ${roleColor}">${user.role}</span>
                        <div class="user-profile">
                            <div class="avatar">${initial}</div>
                            <span class="user-email">${user.email}</span>
                            <button onclick="logout()" class="logout-icon-btn">‚úï</button>
                        </div>
                    </div>
                `;
                loadNotes();
            } else {
                document.getElementById('auth-view').classList.remove('hidden');
            }
        }

        async function loadNotes() {
            const s = document.getElementById('search').value;
            const res = await fetch(`/api/notes?search=${s}&page=${currentPage}`);
            const data = await res.json();
            const list = document.getElementById('notes-list');

            if (!data.notes || data.notes.length === 0) {
                list.innerHTML = "<p style='grid-column: 1/-1; text-align:center; opacity:0.5;'>No records found.</p>";
                document.getElementById('pagination').innerHTML = '';
                return;
            }

            list.innerHTML = data.notes.map(n => `
                <div class="note-card">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <span class="priority-tag p-${n.priority || 'Normal'}">${n.priority || 'Normal'}</span>
                        <span style="font-size: 9px; color: #444; text-transform: uppercase; font-weight: 800;">${n.category || 'General'}</span>
                    </div>
                    <h3 style="margin: 0 0 10px 0;">${n.title}</h3>
                    <p style="color: var(--text-dim); font-size: 0.9rem; flex-grow: 1;">${n.content}</p>
                    <div style="margin-top: 15px; font-size: 10px; color: #333; display: flex; justify-content: space-between;">
                        <span>By: ${n.author || 'User'}</span>
                        <span>${new Date(n.createdAt).toLocaleDateString()}</span>
                    </div>
                    <div style="display: flex; gap: 15px; margin-top: 15px; border-top: 1px solid #1a1a1a; padding-top: 15px;">
                        <span onclick="openEdit('${n._id}','${n.title}','${n.content}')" style="color:var(--gold); font-size:0.7rem; cursor:pointer; font-weight:bold; letter-spacing:1px;">EDIT</span>
                        <span onclick="delNote('${n._id}')" style="color:#444; font-size:0.7rem; cursor:pointer; font-weight:bold; letter-spacing:1px;">DELETE</span>
                    </div>
                </div>
            `).join('');
            renderPagination(data.totalPages);
        }

        function renderPagination(total) {
            const pg = document.getElementById('pagination');
            pg.innerHTML = '';
            if (total <= 1) return;
            for(let i=1; i<=total; i++) {
                pg.innerHTML += `<button onclick="goToPage(${i})" class="pg-btn ${i===currentPage?'active':''}">${i}</button>`;
            }
        }
        function goToPage(p) { currentPage = p; loadNotes(); window.scrollTo(0,0); }

        async function saveNote() {
            const title = document.getElementById('note-title').value.trim();
            const content = document.getElementById('note-content').value.trim();
            const priority = document.getElementById('note-priority').value;
            const category = document.getElementById('note-category').value;
        
            if (title.length < 3) {
                return alert("Please enter a title (minimum 3 characters)");
            }
            if (content.length === 0) {
                return alert("Note content cannot be empty!");
            }
        
            const res = await fetch('/api/notes', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ title, content, priority, category })
            });
        
            if (res.ok) { 
                document.getElementById('note-title').value=''; 
                document.getElementById('note-content').value=''; 
                loadNotes(); 
            } else { 
                const err = await res.json(); 
                alert(err.error); 
            }
        }

        function openAbout() { document.getElementById('aboutModal').style.display = 'block'; }
        function closeAbout() { document.getElementById('aboutModal').style.display = 'none'; }

        function openContact() { document.getElementById('contactModal').style.display = 'block'; }
        function closeContact() { document.getElementById('contactModal').style.display = 'none'; }
        
        async function sendContact() {
            const email = document.getElementById('c-email').value;
            const message = document.getElementById('c-message').value;
            if(!email || !message) return alert("Please fill all fields");

            try {
                const res = await fetch('/api/contact', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, message })
                });
                if (res.ok) {
                    alert("Message saved to data/contacts.json!");
                    closeContact();
                    document.getElementById('c-email').value = '';
                    document.getElementById('c-message').value = '';
                } else {
                    const errorContent = await res.json();
                    alert("Server Error: " + errorContent.error);
                }
            } catch (err) {
                alert("Network error, check your server console.");
            }
        }

        function openEdit(id, t, c) {
            document.getElementById('edit-id').value = id;
            document.getElementById('edit-title').value = t;
            document.getElementById('edit-content').value = c;
            document.getElementById('editModal').style.display = 'block';
        }
        function closeEdit() { document.getElementById('editModal').style.display = 'none'; }
        
        async function updateNote() {
            await fetch(`/api/notes/${document.getElementById('edit-id').value}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ 
                    title: document.getElementById('edit-title').value, 
                    content: document.getElementById('edit-content').value 
                })
            });
            closeEdit(); loadNotes();
        }

        async function handleAuth() {
            const email = document.getElementById('email').value.trim();
            const pass = document.getElementById('pass').value;
        
            // –ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä
            if (!email.includes('@')) {
                return alert("Please enter a valid email");
            }
            if (pass.length < 6) {
                return alert("Password is too short");
            }
        
            const res = await fetch(`/api/auth/${isLogin ? 'login' : 'register'}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password: pass })
            });
        
            const data = await res.json();
            if (res.ok) {
                location.reload();
            } else {
                alert(data.error);
            }
        }
        function setAuthMode(v) { 
            isLogin = v; 
            document.getElementById('t-login').style.color = v ? 'var(--gold)' : '#444';
            document.getElementById('t-reg').style.color = v ? '#444' : 'var(--gold)';
            document.getElementById('auth-btn').innerText = v ? 'SIGN IN' : 'REGISTER';
        }

        async function delNote(id) { if(confirm('Delete this record?')) { await fetch(`/api/notes/${id}`, {method:'DELETE'}); loadNotes(); } }
        async function logout() { await fetch('/api/auth/logout'); location.reload(); }
        
        check();
    </script>
</body>
</html>